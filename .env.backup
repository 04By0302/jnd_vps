# ============================================
# 数据库配置（主从分离）
# ============================================
# 说明：使用公网地址，适用于任何网络环境

# 主库配置（写）- 阿里云RDS MySQL（公网地址）
WRITE_DB_HOST=rm-bp14172o6ehyk82g0vo.mysql.rds.aliyuncs.com
WRITE_DB_PORT=3306
WRITE_DB_NAME=new_api
WRITE_DB_USER=new_api
WRITE_DB_PASSWORD=04By0302

# 从库配置（读）- 阿里云RDS MySQL只读实例（公网地址）
READ_DB_HOST=rm-bp119pgkr2vs02t18go.mysql.rds.aliyuncs.com
READ_DB_PORT=3306
READ_DB_NAME=new_api
READ_DB_USER=new_api
READ_DB_PASSWORD=04By0302

# Prisma 数据库连接（用于迁移，使用主库公网地址）
DATABASE_URL="mysql://new_api:04By0302@rm-bp14172o6ehyk82g0vo.mysql.rds.aliyuncs.com:3306/new_api"

# ============================================
# 数据库连接优化参数（公网访问优化）
# ============================================
# 跨云公网访问优化配置，增强连接稳定性，减少"Aborted connection"错误
# 这些参数已针对公网访问进行优化，如网络稳定可不修改

# 连接超时（秒）- 公网建立连接较慢
# 推荐值：内网10-30秒，公网60-90秒
DB_CONNECT_TIMEOUT=60

# Socket超时（秒）- 公网数据传输较慢
# 推荐值：内网30-60秒，公网120-180秒
DB_SOCKET_TIMEOUT=120

# 连接池超时（秒）- 等待可用连接的时间
# 高并发场景：增加到120秒，给予更多等待时间
DB_POOL_TIMEOUT=120

# 写库连接数限制
# 高并发优化：7个数据源 + AI预测 + 统计更新 + 健康检查 + 缓冲
# 推荐值：1核2G=50-80，2核4G=80-150，4核8G=150-300
# 数据库专用场景可以大幅提升
WRITE_DB_CONNECTION_LIMIT=100

# 读库连接数限制
# 高并发优化：大量用户查询 + API请求 + Excel导出 + 内部查询
# 推荐值：500-1000个连接适合500-2000个并发用户
# 数据库专用场景可以充分利用资源
READ_DB_CONNECTION_LIMIT=500

# ============================================
# Redis配置（公网地址）
# ============================================
# 跨云公网访问优化说明：
# - 连接超时已设置为30秒（代码中配置）
# - 命令超时已设置为10秒（代码中配置）
# - TCP Keepalive已启用（代码中配置）
# - 如遇连接超时，请检查：
#   1. Redis白名单是否添加服务器IP
#   2. 服务器安全组是否开放6379端口
#   3. 网络连通性（ping/telnet测试）
REDIS_HOST=r-bp1m85dvrgmkgmdipfpd.redis.rds.aliyuncs.com
REDIS_PORT=6379
REDIS_PASSWORD=04By0302
REDIS_USERNAME=new_api

# ============================================
# 应用配置
# ============================================
NODE_ENV=production
LOG_LEVEL=info

# 输出路径
OUTPUT_DIR=./output

# 时区配置（重要！必须设置为Asia/Shanghai）
TZ=Asia/Shanghai

# ============================================
# DeepSeek AI配置
# ============================================
AI_API_KEY=sk-dab902d41bbf4d32843e0b718ee3ebab
AI_API_URL=https://api.deepseek.com/v1/chat/completions
AI_MODEL=deepseek-chat
AI_TIMEOUT=30000

# ============================================
# 高并发优化说明
# ============================================
# 当前配置已针对高并发场景优化：
# 
# 写库连接池 (100)：
#   - 7个数据源抓取器（并发写入）
#   - AI预测写入
#   - 统计数据更新
#   - 健康检查
#   - 缓冲余量
# 
# 读库连接池 (500)：
#   - 支持 500-2000 个并发用户
#   - API查询请求
#   - Excel导出（限制3个并发）
#   - 内部数据查询
#   - 缓存失效时的降级查询
# 
# 进一步优化建议：
#   1. 如果仍有连接池超时，可继续增加连接数
#   2. 监控MySQL的 max_connections 配置（建议 >= 1000）
#   3. 监控服务器内存使用（每个连接约占用 1-2MB）
#   4. 考虑启用MySQL连接池复用（默认已启用）
#   5. 定期检查慢查询日志，优化SQL性能
# 
# MySQL服务器端建议配置：
#   max_connections = 1000          # 最大连接数
#   max_connect_errors = 100000     # 最大连接错误数
#   wait_timeout = 28800            # 连接空闲超时（8小时）
#   interactive_timeout = 28800     # 交互式连接超时
#   thread_cache_size = 100         # 线程缓存

# ============================================
# 缓存配置
# ============================================
CACHE_LOCK_TTL=3
CACHE_SEEN_TTL=3600
CACHE_DATA_TTL=180
CACHE_WINRATE_TTL=300

# ============================================
# 重试配置
# ============================================
RETRY_MAX_ATTEMPTS=3
RETRY_INITIAL_DELAY=1000
RETRY_MAX_DELAY=10000

# ============================================
# AI预测配置
# ============================================
PREDICT_GROUP_DELAY=2000
PREDICT_LOCK_TTL=300

# ============================================
# 限流配置
# ============================================
RATE_LIMIT_API_MAX=120
RATE_LIMIT_STRICT_MAX=30
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_BLACKLIST_DURATION=1800

# ============================================
# 性能阈值配置
# ============================================
PERF_API_MAX_LATENCY=50
PERF_FETCHER_MAX_DELAY=2000
PERF_DB_MAX_QUERY_TIME=20

# ============================================
# Cloudflare CDN配置（可选）
# ============================================
# 说明：接入Cloudflare后可自动清除CDN缓存，确保用户获取最新数据
# 未配置时系统仍可正常运行，但CDN缓存需等待TTL过期

# 是否启用Cloudflare缓存清理（true/false）
CF_ENABLED=false

# Cloudflare Zone ID（在Cloudflare域名概览页面右侧栏查看）
# 示例：a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
CF_ZONE_ID=

# Cloudflare API Token（需要Cache Purge权限）
# 创建路径：Cloudflare控制台 -> 我的个人资料 -> API令牌 -> 创建令牌
# 权限选择：Zone - Cache Purge - Purge
# 示例：abcdefghijklmnopqrstuvwxyz123456789
CF_API_TOKEN=

# 网站完整域名（包含协议，不要以斜杠结尾）
# 示例：https://yourdomain.com
BASE_URL=

# ============================================
# 使用说明
# ============================================
# 1. 复制此文件为 .env（去掉.template后缀）
# 2. 以上地址为公网地址，适用于任何网络环境
# 3. 确认数据库白名单已添加服务器IP
# 4. 确认MySQL max_connections >= 1000
# 5. 如遇连接问题，可适当增加 DB_CONNECT_TIMEOUT 和 DB_SOCKET_TIMEOUT
# 6. Cloudflare配置为可选项，未配置不影响系统运行
